name: Release

on:
  push:
    branches:
      - master   # ensure this matches your release branch

permissions:
  contents: write   # required to push tags
  issues: write     # required to create GitHub releases
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0   # required for semantic-release to access tags

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Install Dependencies
        run: npm ci

      # ✅ Debug Step: Show Environment Variables & Git Info
      - name: Debug Environment
        run: |
          echo "Current Branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Available Tags:"
          git tag
          echo "Node Version:"
          node -v
          echo "NPM Version:"
          npm -v

      # ✅ Debug Step: Test if Tokens Exist
      - name: Verify Secrets
        run: |
          if [ -z "$GITHUB_TOKEN" ]; then echo "❌ GITHUB_TOKEN not found"; exit 1; fi
          if [ -z "$NPM_TOKEN" ]; then echo "❌ NPM_TOKEN not found"; exit 1; fi
          echo "✅ Tokens are set"

      # ✅ Dry Run First (See What Would Happen)
      - name: Semantic Release (Dry Run - Debugging)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # or secrets.GH_TOKEN if using a PAT
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          DEBUG: semantic-release:*
        run: npx semantic-release --dry-run

      # ✅ Actual Release (Only Runs if Dry Run Passes)
      - name: Semantic Release (Actual Run)
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          DEBUG: semantic-release:*
        run: npx semantic-release
