name: Semantic Release Test

on:
  push:
    branches:
      - feat/semantic-release   # ✅ only triggers on this branch

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0   # semantic-release needs full history

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Install Dependencies
        run: npm ci

      # ✅ Debugging Info
      - name: Debug Environment
        run: |
          echo "🔍 Current Branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "🔍 Git Tags:"
          git tag
          echo "🔍 Node Version:"
          node -v
          echo "🔍 NPM Version:"
          npm -v

      # ✅ Verify Secrets Exist
      - name: Verify Secrets
        run: |
          if [ -z "$GITHUB_TOKEN" ]; then echo "❌ GH_TOKEN not found"; exit 1; fi
          if [ -z "$NPM_TOKEN" ]; then echo "❌ NPM_TOKEN not found"; exit 1; fi
          echo "✅ Tokens detected"

      # ✅ Run Semantic Release in Debug Dry-Run Mode
      - name: Semantic Release Dry Run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # or map secrets.GH_TOKEN here
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          DEBUG: semantic-release:*
        run: npx semantic-release --dry-run
